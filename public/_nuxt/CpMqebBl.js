import{_ as F,r as v,x,g as W,c as l,a as e,k as i,F as L,l as q,m,v as f,t as u,n as C,z as G,p as J,o as n}from"./BSD6ajEG.js";const K={class:"install-container"},Q={class:"install-card"},X={class:"steps-container"},Y={class:"steps-indicator"},Z={class:"step-number"},ss={class:"step-label"},es={key:0,class:"step-content"},ts={class:"form-group"},os=["disabled"],ls={key:0,class:"error-text"},ns={class:"form-group"},as=["disabled"],rs={class:"form-group"},is=["disabled"],ds={key:0,class:"error-text"},us={class:"form-group"},ps=["disabled"],cs={key:0,class:"error-text"},vs={class:"form-group"},ms=["disabled"],fs={class:"button-group"},bs=["disabled"],_s={key:0},ys={key:1},gs=["disabled"],ws={key:1,class:"step-content"},Ds={class:"form-group"},Ps={key:0,class:"error-text"},ks={class:"form-group"},Bs={key:0,class:"error-text"},Ss={class:"form-group"},hs={key:0,class:"error-text"},xs={class:"button-group"},Us=["disabled"],Os={key:2,class:"step-content"},Ts={key:0,class:"install-confirm"},Es={key:1,class:"installing"},Cs={class:"install-progress"},Rs={class:"progress-bar"},As={key:2,class:"install-complete"},Ns={key:3,class:"install-error"},Vs={__name:"install",setup(Hs){const R=J(),U=[{label:"数据库配置"},{label:"管理员设置"},{label:"安装系统"}],p=v(0),r=x({DB_HOST:"localhost",DB_PORT:3306,DB_NAME:"auth",DB_USER:"root",DB_PASSWORD:""}),a=x({username:"admin",password:"",confirmPassword:""}),o=x({}),c=v(!1),P=v(!1),b=v(null),k=v(!1),B=v(!1),g=v(null),S=v(0),_=v(""),y=v("准备安装系统..."),A=W(()=>a.username&&a.password&&a.password===a.confirmPassword&&a.password.length>=6);function N(){return Object.keys(o).forEach(d=>delete o[d]),r.DB_HOST||(o.DB_HOST="数据库主机不能为空"),r.DB_NAME||(o.DB_NAME="数据库名称不能为空"),r.DB_USER||(o.DB_USER="数据库用户名不能为空"),Object.keys(o).length===0}function V(){return Object.keys(o).forEach(d=>delete o[d]),a.username||(o.adminUsername="管理员用户名不能为空"),a.password?a.password.length<6&&(o.adminPassword="密码长度不能少于6个字符"):o.adminPassword="管理员密码不能为空",a.password!==a.confirmPassword&&(o.confirmPassword="两次输入的密码不一致"),Object.keys(o).length===0}async function H(){var d,s;if(N()){c.value=!0,b.value=null;try{const t=await $fetch("/api/install/test-connection",{method:"POST",body:r});console.log("数据库连接测试结果:",t),t.error?(P.value=!1,b.value={success:!1,message:"数据库连接失败！"+t.error}):(P.value=!0,b.value={success:!0,message:"数据库连接成功！"})}catch(t){console.error("数据库连接测试失败:",t),b.value={success:!1,message:`数据库连接失败: ${((s=(d=t.response)==null?void 0:d.data)==null?void 0:s.message)||t.message}`}}finally{c.value=!1}}}function O(){p.value===0&&!P.value||p.value===1&&!V()||p.value<U.length-1&&p.value++}function T(){p.value>0&&p.value--}async function E(){var d,s;k.value=!0,g.value=null,S.value=0;try{y.value="保存数据库配置...",_.value="正在保存数据库配置",await w(0,20),await $fetch("/api/install/save-config",{method:"POST",body:r}),y.value="连接数据库...",_.value="正在连接到数据库",await w(20,40),y.value="初始化数据库...",_.value="正在创建数据库表",await w(40,70),y.value="创建管理员账户...",_.value="正在设置管理员账户",await w(70,90),await $fetch("/api/install",{method:"POST",body:{dbConfig:r,adminConfig:a}}),y.value="完成安装...",_.value="安装即将完成",await w(90,100),B.value=!0}catch(t){console.error("安装失败:",t),g.value=((s=(d=t.response)==null?void 0:d.data)==null?void 0:s.message)||"安装过程中出现错误，请检查日志"}finally{k.value=!1}}async function w(d,s){const I=(s-d)/20,$=1e3/20;for(let h=0;h<20;h++)await new Promise(z=>setTimeout(z,$)),S.value=Math.min(d+I*(h+1),s)}function M(){g.value=null,E()}function j(){R.push("/login")}return(d,s)=>(n(),l("div",K,[e("div",Q,[s[27]||(s[27]=e("h1",{class:"text-2xl font-bold mb-6"},"简授权安装",-1)),e("div",X,[e("div",Y,[(n(),l(L,null,q(U,(t,D)=>e("div",{key:D,class:C(["step",{active:p.value>=D,completed:p.value>D}])},[e("div",Z,u(D+1),1),e("div",ss,u(t.label),1)],2)),64))]),p.value===0?(n(),l("div",es,[s[13]||(s[13]=e("h2",{class:"text-xl font-semibold mb-4"},"数据库配置",-1)),e("div",ts,[s[8]||(s[8]=e("label",{for:"dbHost"},"数据库主机",-1)),m(e("input",{type:"text",id:"dbHost","onUpdate:modelValue":s[0]||(s[0]=t=>r.DB_HOST=t),placeholder:"localhost",disabled:c.value},null,8,os),[[f,r.DB_HOST]]),o.DB_HOST?(n(),l("span",ls,u(o.DB_HOST),1)):i("",!0)]),e("div",ns,[s[9]||(s[9]=e("label",{for:"dbPort"},"数据库端口",-1)),m(e("input",{type:"number",id:"dbPort","onUpdate:modelValue":s[1]||(s[1]=t=>r.DB_PORT=t),placeholder:"3306",disabled:c.value},null,8,as),[[f,r.DB_PORT]])]),e("div",rs,[s[10]||(s[10]=e("label",{for:"dbName"},"数据库名称",-1)),m(e("input",{type:"text",id:"dbName","onUpdate:modelValue":s[2]||(s[2]=t=>r.DB_NAME=t),placeholder:"auth",disabled:c.value},null,8,is),[[f,r.DB_NAME]]),o.DB_NAME?(n(),l("span",ds,u(o.DB_NAME),1)):i("",!0)]),e("div",us,[s[11]||(s[11]=e("label",{for:"dbUser"},"数据库用户名",-1)),m(e("input",{type:"text",id:"dbUser","onUpdate:modelValue":s[3]||(s[3]=t=>r.DB_USER=t),placeholder:"root",disabled:c.value},null,8,ps),[[f,r.DB_USER]]),o.DB_USER?(n(),l("span",cs,u(o.DB_USER),1)):i("",!0)]),e("div",vs,[s[12]||(s[12]=e("label",{for:"dbPassword"},"数据库密码",-1)),m(e("input",{type:"password",id:"dbPassword","onUpdate:modelValue":s[4]||(s[4]=t=>r.DB_PASSWORD=t),placeholder:"数据库密码",disabled:c.value},null,8,ms),[[f,r.DB_PASSWORD]])]),e("div",fs,[e("button",{onClick:H,class:"btn-test",disabled:c.value},[c.value?(n(),l("span",_s,"测试连接中...")):(n(),l("span",ys,"测试连接"))],8,bs),e("button",{onClick:O,class:"btn-primary",disabled:!P.value||c.value}," 下一步 ",8,gs)]),b.value?(n(),l("div",{key:0,class:C(["connection-result",b.value.success?"success":"error"])},u(b.value.message),3)):i("",!0)])):i("",!0),p.value===1?(n(),l("div",ws,[s[17]||(s[17]=e("h2",{class:"text-xl font-semibold mb-4"},"管理员账户设置",-1)),e("div",Ds,[s[14]||(s[14]=e("label",{for:"adminUsername"},"管理员用户名",-1)),m(e("input",{type:"text",id:"adminUsername","onUpdate:modelValue":s[5]||(s[5]=t=>a.username=t),placeholder:"admin"},null,512),[[f,a.username]]),o.adminUsername?(n(),l("span",Ps,u(o.adminUsername),1)):i("",!0)]),e("div",ks,[s[15]||(s[15]=e("label",{for:"adminPassword"},"管理员密码",-1)),m(e("input",{type:"password",id:"adminPassword","onUpdate:modelValue":s[6]||(s[6]=t=>a.password=t),placeholder:"请输入密码"},null,512),[[f,a.password]]),o.adminPassword?(n(),l("span",Bs,u(o.adminPassword),1)):i("",!0)]),e("div",Ss,[s[16]||(s[16]=e("label",{for:"confirmPassword"},"确认密码",-1)),m(e("input",{type:"password",id:"confirmPassword","onUpdate:modelValue":s[7]||(s[7]=t=>a.confirmPassword=t),placeholder:"请再次输入密码"},null,512),[[f,a.confirmPassword]]),o.confirmPassword?(n(),l("span",hs,u(o.confirmPassword),1)):i("",!0)]),e("div",xs,[e("button",{onClick:T,class:"btn-secondary"},"上一步"),e("button",{onClick:O,class:"btn-primary",disabled:!A.value},"下一步",8,Us)])])):i("",!0),p.value===2?(n(),l("div",Os,[s[26]||(s[26]=e("h2",{class:"text-xl font-semibold mb-4"},"系统安装",-1)),!k.value&&!B.value?(n(),l("div",Ts,[s[18]||(s[18]=e("p",null,'所有配置已完成，点击"开始安装"按钮开始安装系统。',-1)),s[19]||(s[19]=e("p",null,"安装过程中请不要关闭浏览器或刷新页面。",-1)),e("div",{class:"button-group"},[e("button",{onClick:T,class:"btn-secondary"},"上一步"),e("button",{onClick:E,class:"btn-primary"},"开始安装")])])):i("",!0),k.value?(n(),l("div",Es,[s[20]||(s[20]=e("div",{class:"loading-spinner"},null,-1)),e("div",Cs,[e("h3",null,u(y.value),1),e("div",Rs,[e("div",{class:"progress",style:G({width:S.value+"%"})},null,4)]),e("p",null,u(_.value),1)])])):i("",!0),B.value?(n(),l("div",As,[s[21]||(s[21]=e("div",{class:"success-icon"},"✓",-1)),s[22]||(s[22]=e("h3",null,"安装完成！",-1)),s[23]||(s[23]=e("p",null,"简授权已成功安装，您现在可以使用系统了。",-1)),e("div",{class:"button-group"},[e("button",{onClick:j,class:"btn-primary"},"前往登录")])])):i("",!0),g.value?(n(),l("div",Ns,[s[24]||(s[24]=e("div",{class:"error-icon"},"✗",-1)),s[25]||(s[25]=e("h3",null,"安装失败",-1)),e("p",null,u(g.value),1),e("div",{class:"button-group"},[e("button",{onClick:M,class:"btn-primary"},"重试安装")])])):i("",!0)])):i("",!0)])])]))}},js=F(Vs,[["__scopeId","data-v-6dfa8625"]]);export{js as default};
